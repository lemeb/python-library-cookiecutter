name: Update repository with Cruft
permissions:
  contents: write
  pull-requests: write
on:
  schedule:
    - cron: "0 2 * * *" # Every day at 2am UTC
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          # NOTE: By default, this workflow will ignore GitHub Actions
          # workflow files. This is because you will most likely run
          # this workflow with the default GITHUB_TOKEN, which does
          # not have permissions to push anything that would edit a
          # workflow.
          # This means that any changes to GH workflows in the template
          # repository WILL be silently ignored; any upstream change
          # you might want to make will have to be done manually.
          # If you want workflow files to be updated automatically, you
          # will need to specify a personal access token (PAT) in the
          # secrets of this repository. You can find reference code that
          # alludes to this possibility later in the file.
          # To include workflow files, delete the "!.github/workflows/" line and use a PAT
          - add-paths: |
              .
              !.github/workflows/
            body: Use this to merge the changes to this repository.
            branch: cruft/update
            commit-message: "chore: accept new Cruft update"
            title: New updates detected with Cruft
          - add-paths: .cruft.json
            body: Use this to reject the changes in this repository.
            branch: cruft/reject
            commit-message: "chore: reject new Cruft update"
            title: Reject new updates detected with Cruft
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Cruft
        run: pip3 install cruft

      - name: Check if update is available
        continue-on-error: false
        id: check
        run: |
          CHANGES=0
          if [ -f .cruft.json ]; then
            if ! cruft check; then
              CHANGES=1
            fi
          else
            echo "No .cruft.json file"
          fi

          echo "has_changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Run update if available
        if: steps.check.outputs.has_changes == '1'
        run: |
          git config --global user.email "automated@example.com"
          git config --global user.name "Automated [Cruft]"

          cruft update --skip-apply-ask --refresh-private-variables
          git restore --staged .

      - name: Create pull request
        if: steps.check.outputs.has_changes == '1'
        uses: peter-evans/create-pull-request@v4
        with:
          # NOTE: As indicated above, the default GITHUB_TOKEN will not
          # have permissions to modify workflow files. If you want to have
          # such modifications being done anyway, generate a GitHub
          # Personal Access Token with permissons to edit workflows,
          # define it as a secret in your repository, and use it in the
          # line below.
          # More info can be found here:
          # https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens
          token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
          add-paths: {% raw %}${{ matrix.add-paths }}{% endraw %}
          commit-message: {% raw %}${{ matrix.commit-message }}{% endraw %}
          branch: {% raw %}${{ matrix.branch }}{% endraw %}
          delete-branch: true
          branch-suffix: timestamp
          title: {% raw %}${{ matrix.title }}{% endraw %}
          body: |
            This is an autogenerated PR. {% raw %}${{ matrix.body }}{% endraw %}

            [Cruft](https://cruft.github.io/cruft/) has detected updates from the Cookiecutter repository.
